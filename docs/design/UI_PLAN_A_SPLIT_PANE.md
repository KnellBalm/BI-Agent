# UI Plan A: Warp-style Split Pane

> BI-Agent UI Redesign Proposal - Textual 기반 Split Pane 하이브리드

**작성일:** 2026-02-20
**버전:** v0.1.0-draft
**대상 프로젝트:** BI-Agent (`/Users/zokr/python_workspace/BI-Agent`)

---

## 1. 개요 및 컨셉

### 1.1 핵심 아이디어

기존 Textual 풀스크린 TUI(`bi_agent_console.py`)의 레이아웃을 **Warp 터미널 스타일의 상하 분할 구조**로 전환한다.
Textual 프레임워크를 그대로 유지하면서, 사용자에게 **CLI처럼 느껴지는 입력 경험**과 **TUI처럼 위에서 스크롤하며 볼 수 있는 히스토리**를 동시에 제공한다.

### 1.2 디자인 원칙

| 원칙 | 설명 |
|------|------|
| **CLI-first 입력** | 하단 고정 입력창, 슬래시 명령어, 자동완성, 히스토리 탐색 |
| **TUI-style 결과** | 상단 스크롤 영역에 rich 렌더링된 결과가 쌓임 |
| **배너/상태 통합** | ASCII 배너와 HUD 상태바를 상단에 고정 표시 |
| **기존 자산 활용** | Textual App, MessageBubble, ThinkingPanel, HUDStatusLine 재사용 |

### 1.3 참고 인터페이스

- **Warp Terminal**: 상단 히스토리 + 하단 고정 입력
- **Claude CLI**: 배너 출력 후 프롬프트, 결과가 위로 쌓임
- **lazygit/lazydocker**: Textual 기반 패널 분할 TUI


---

## 2. 유저 저니 (User Journey)

### 시나리오 1: 첫 실행

```
1. 사용자가 `bi-agent` 명령어로 앱 실행
2. 화면이 열리며 상단에 ASCII 배너 + 버전/연결 상태 표시
3. 하단 입력창에 커서가 깜빡임 (placeholder: "질문을 입력하세요...")
4. 사용자가 `/help` 입력 -> 상단 히스토리 패널에 도움말 카드가 표시됨
5. 사용자가 `/connect` 입력 -> 연결 설정 모달(Screen)이 오버레이로 뜸
6. 연결 완료 후 HUD 상태바에 녹색 체크 표시
```

### 시나리오 2: 데이터 분석 질문

```
1. 입력창에 "월별 매출 트렌드를 분석해줘" 입력
2. 입력창 바로 위에 ThinkingPanel 표시 (스피너 + 단계 표시)
   ┌─ Thinking ─────────────────────┐
   │ [1/3] 테이블 스캔 중...         │
   │ [2/3] SQL 생성 중...            │
   │ [3/3] 결과 분석 중...           │
   └────────────────────────────────┘
3. 완료 시 ThinkingPanel이 사라지고, 히스토리 패널에 결과 블록 추가:
   - 사용자 질문 (dim 스타일)
   - SQL 코드블록 (접기 가능)
   - 데이터 테이블 (rich Table)
   - 분석 인사이트 (Markdown 렌더링)
4. 히스토리 패널이 자동 스크롤되어 최신 결과를 보여줌
5. 사용자가 위로 스크롤하면 이전 질문-응답 쌍을 확인 가능
```

### 시나리오 3: 명령어 자동완성

```
1. 사용자가 `/` 입력
2. 입력창 바로 위에 CommandPalette 드롭업 표시
   ┌──────────────────────────────┐
   │ /connect   데이터소스 연결     │
   │ /list      연결 목록           │
   │ /explore   스키마 탐색         │
   │ /export    결과 내보내기       │
   │ /clear     화면 초기화         │
   │ /quit      종료                │
   └──────────────────────────────┘
3. 화살표 키로 선택, Tab으로 자동완성
4. 선택한 명령어가 입력창에 채워짐
```

### 시나리오 4: 히스토리 탐색

```
1. 입력창에서 위 화살표 키 -> 이전 입력 내역 순회
2. Ctrl+R -> 히스토리 검색 모드 진입
3. 검색어 입력 시 매칭되는 이전 명령어를 입력창에 표시
```


---

## 3. UI 레이아웃 ASCII 목업

### 3.1 기본 레이아웃 (전체 터미널)

```
┌─────────────────────────────────────────────────────────────────────┐
│  BI-Agent Console v1.0                              12:34:56  [?]  │  <- Header (Textual)
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│     ____  ____     ___                    __                        │
│    / __ )/  _/    /   | ____ ____  ____  / /_                       │  <- ASCII Banner
│   / __  |/ /_____/ /| |/ __ `/ _ \/ __ \/ __/                      │     (초기 1회)
│  / /_/ // /_____/ ___ / /_/ /  __/ / / / /_                        │
│ /_____/___/    /_/  |_\__, /\___/_/ /_/\__/                        │
│                      /____/                                         │
│                                                                     │
│  v0.1.0  *  DB: my_postgres (PostgreSQL)  *  /help                 │  <- Status Line
│─────────────────────────────────────────────────────────────────────│
│                                                                     │
│  [You] 월별 매출 트렌드를 분석해줘                                    │  <- History Panel
│                                                                     │     (VerticalScroll)
│  [BI-Agent] -----------------------------------------------        │
│  | ## 월별 매출 트렌드 분석                                          │
│  |                                                                  │
│  | ```sql                                                           │
│  | SELECT DATE_TRUNC('month', order_date) AS month,                 │
│  |        SUM(amount) AS total_sales                                │
│  | FROM orders GROUP BY 1 ORDER BY 1;                               │
│  | ```                                                              │
│  |                                                                  │
│  | | month    | total_sales |                                       │
│  | |----------|-------------|                                       │
│  | | 2025-01  | 12,340,000  |                                       │
│  | | 2025-02  | 15,670,000  |                                       │
│  | | 2025-03  | 11,890,000  |                                       │
│  |                                                                  │
│  | > 2월에 매출이 26.9% 증가했으며, 3월에는 소폭 감소했습니다.         │
│  ---------------------------------------------------------------    │
│                                                                     │
│  [You] 가장 많이 팔린 상품 TOP 5는?                                  │
│                                                                     │
│  [BI-Agent] -----------------------------------------------        │
│  | ...                                                              │
│  ---------------------------------------------------------------    │
│                                                                     │
├── HUD ──────────────────────────────────────────────────────────────┤
│  Auth: OK | DB: my_postgres | Tables: 12 | Quota: 847/1000         │  <- HUD Status
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  > 질문을 입력하세요... (/ 로 명령어)                     [Send]     │  <- Fixed Input
│                                                                     │
├─────────────────────────────────────────────────────────────────────┤
│  q Quit | v Visual | Ctrl+L Clear | F1 Help                        │  <- Footer (Textual)
└─────────────────────────────────────────────────────────────────────┘
```

### 3.2 ThinkingPanel 활성 상태

```
├─────────────────────────────────────────────────────────────────────┤
│  ...히스토리...                                                      │
│                                                                     │
│  [You] 지역별 매출 비교                                              │
│                                                                     │
│  ┌─ Thinking ──────────────────────────────────────────────┐        │
│  │  [*] 테이블 스캔: orders, regions (2 tables)            │        │
│  │  [*] SQL 생성 완료                                       │        │
│  │  [ ] 쿼리 실행 중...  ⠋                                  │        │
│  └─────────────────────────────────────────────────────────┘        │
├── HUD ──────────────────────────────────────────────────────────────┤
│  Auth: OK | DB: my_postgres | Tables: 12 | Quota: 848/1000         │
├─────────────────────────────────────────────────────────────────────┤
│  > _                                                     [Send]     │
├─────────────────────────────────────────────────────────────────────┤
```

### 3.3 CommandPalette 드롭업 상태

```
├─────────────────────────────────────────────────────────────────────┤
│  ...히스토리...                                                      │
├── HUD ──────────────────────────────────────────────────────────────┤
│  Auth: OK | DB: my_postgres                                         │
├─────────────────────────────────────────────────────────────────────┤
│  ┌──────────────────────────────────────────┐                       │
│  │  /connect     데이터소스 연결              │                       │
│  │  /list        연결 목록                    │  <- Drop-up Palette  │
│  │  /explore     스키마 탐색                  │                       │
│  │ >/export      결과 내보내기               │  <- 선택 하이라이트   │
│  │  /clear       화면 초기화                  │                       │
│  │  /quit        종료                         │                       │
│  └──────────────────────────────────────────┘                       │
│  > /ex_                                                  [Send]     │
├─────────────────────────────────────────────────────────────────────┤
```


---

## 4. 구현 계획 (단계별)

### Phase 1: 레이아웃 재구성 (핵심)

**목표:** 기존 `bi_agent_console.py`의 `compose()` 메서드를 리디자인하여 상하 분할 구조로 전환.

**작업 내용:**

1. `compose()` 메서드 재작성
   - 기존: `Horizontal(chat-area, sidebar)` 구조
   - 변경: `Vertical(header, banner, history-scroll, hud, input-area, footer)` 구조
   - 사이드바는 토글 가능한 오버레이로 전환 (기본 숨김)

2. 히스토리 패널 위젯 구현
   - `VerticalScroll` 컨테이너를 사용하여 `MessageBubble` 위젯을 아래로 쌓음
   - 자동 스크롤: 새 메시지 추가 시 하단으로 스크롤
   - 수동 스크롤: 사용자가 위로 스크롤하면 자동 스크롤 일시 중지

3. 하단 고정 입력 영역
   - `Input` 위젯 + `Button`을 `Dock(edge="bottom")`으로 고정
   - TCSS에서 `dock: bottom; height: 3;` 설정

4. TCSS 전면 재작성
   - 기존 `app_styles.tcss`를 `app_styles_split.tcss`로 교체
   - 다크 테마 기본, CLI 느낌의 모노스페이스 폰트 강조

**완료 기준:**
- 앱 실행 시 상단 히스토리 + 하단 고정 입력 레이아웃 표시
- 입력한 내용이 히스토리 패널에 쌓임
- 위/아래 스크롤이 정상 동작

### Phase 2: CLI 입력 강화

**목표:** 하단 입력창에 prompt_toolkit 수준의 CLI 경험 제공.

**작업 내용:**

1. Textual `Input` 위젯 커스터마이징
   - 히스토리 탐색 (Up/Down 화살표로 이전 입력 순회)
   - 기존 `CommandHistory` 클래스와 연동

2. CommandPalette 드롭업 구현
   - `/` 입력 시 기존 `CommandPalette` 로직을 입력창 바로 위에 표시
   - `OptionList` 위젯을 `overlay` 레이어에 배치
   - fuzzy matching으로 타이핑에 따른 필터링

3. 자동완성 힌트
   - 히스토리 기반 auto-suggest (dim 텍스트로 표시)
   - Tab 키로 완성

**완료 기준:**
- Up/Down 키로 히스토리 탐색
- `/` 입력 시 명령어 팔레트 표시
- 타이핑 시 fuzzy 필터링 동작

### Phase 3: 결과 렌더링 고도화

**목표:** 히스토리 패널에 표시되는 결과 블록의 품질 향상.

**작업 내용:**

1. `ResultBlock` 위젯 신규 개발
   - 질문-응답 쌍을 하나의 카드로 묶는 커스텀 위젯
   - 내부 구성: 질문 라벨 + SQL 코드블록 + 데이터 테이블 + 인사이트 텍스트
   - SQL 코드블록은 기본 접힘, 클릭/키보드로 펼침

2. `ThinkingPanel` 위치 변경
   - 기존: 별도 영역
   - 변경: 히스토리 패널 하단 (입력창 바로 위)에 실시간 표시
   - 완료 시 `ResultBlock`으로 교체

3. 데이터 테이블 개선
   - 기존 `DataTable` 위젯 재활용
   - 10행 초과 시 "더보기" 토글
   - 컬럼 너비 자동 조절

**완료 기준:**
- 질문-응답이 카드 형태로 히스토리에 쌓임
- SQL 접기/펼치기 동작
- ThinkingPanel이 결과로 전환되는 애니메이션

### Phase 4: 배너 및 상태 통합

**목표:** CLI 느낌의 배너와 상태 표시 통합.

**작업 내용:**

1. ASCII 배너 표시
   - 앱 최초 실행 시 히스토리 패널 최상단에 배너 렌더링
   - `backend/main.py`의 `BANNER` 상수 재활용
   - 버전, 연결 상태, 도움말 안내 포함

2. HUD StatusLine 재배치
   - 히스토리 패널과 입력 영역 사이에 1줄 HUD 배치
   - 기존 `HUDStatusLine` 위젯 재활용
   - Auth, DB, Tables, Quota 정보 실시간 표시

3. 사이드바 토글화
   - 기존 우측 사이드바를 `Ctrl+B`로 토글하는 오버레이로 전환
   - 기본 상태: 숨김 (CLI 느낌 극대화)
   - 필요 시 열어서 상세 정보 확인

**완료 기준:**
- 배너가 첫 화면에 표시됨
- HUD가 입력 영역 바로 위에 1줄로 표시됨
- Ctrl+B로 사이드바 토글 동작

### Phase 5: 통합 테스트 및 폴리싱

**목표:** 전체 플로우 검증 및 에지 케이스 처리.

**작업 내용:**

1. 통합 테스트
   - 전체 유저 저니 시나리오 수동 테스트
   - 긴 SQL 결과, 에러 응답, 연결 끊김 시 동작 확인
   - 터미널 크기 변경(리사이즈) 대응 확인

2. 키보드 단축키 정리
   - 기존 바인딩 유지 + 새 바인딩 추가
   - `Ctrl+L` 히스토리 초기화, `Ctrl+B` 사이드바, `Escape` 팔레트 닫기

3. 성능 최적화
   - 히스토리 블록이 100개 이상일 때 가상 스크롤 적용 검토
   - ThinkingPanel 렌더링 주기 최적화

**완료 기준:**
- 모든 시나리오에서 크래시 없음
- 리사이즈 시 레이아웃 정상 유지
- 키보드 단축키 충돌 없음


---

## 5. 기술 스택 선택 이유

### 5.1 Textual 유지 이유

| 근거 | 설명 |
|------|------|
| **기존 자산** | `bi_agent_console.py`에 이미 Textual 기반 App, Screen, Widget 구현이 완료되어 있음. `MessageBubble`, `ThinkingPanel`, `StreamingMessageView`, `ToolActivityTracker`, `HUDStatusLine` 등 커스텀 위젯 재사용 가능. |
| **Screen 시스템** | `ProjectScreen`, `TableSelectionScreen`, `DatabaseExplorerScreen` 등 모달 Screen이 이미 구현됨. 오버레이/모달 패턴을 레이아웃 변경 없이 유지 가능. |
| **TCSS 스타일링** | 레이아웃 변경이 Python 코드 최소 수정 + TCSS 파일 교체로 가능. |
| **비동기 지원** | Textual의 async 이벤트 루프가 `AgenticOrchestrator`의 `await orchestrator.run()`과 자연스럽게 통합됨. |
| **풍부한 위젯** | `DataTable`, `RichLog`, `OptionList`, `Input` 등 필요한 위젯이 빌트인으로 제공됨. |

### 5.2 prompt_toolkit을 쓰지 않는 이유

| 이유 | 설명 |
|------|------|
| **이벤트 루프 충돌** | Textual과 prompt_toolkit 모두 자체 이벤트 루프를 가짐. 한 앱에서 두 이벤트 루프를 돌리면 복잡도가 급격히 증가. |
| **Input 위젯 충분** | Textual의 `Input` 위젯이 prompt_toolkit의 핵심 기능(히스토리, 자동완성)을 위젯 레벨에서 구현 가능. |
| **통합 테스팅** | Textual은 `pilot` 테스트 프레임워크를 제공하여 UI 테스트 자동화가 가능. prompt_toolkit 혼합 시 테스트가 어려워짐. |

### 5.3 rich 활용

- `Markdown`, `Table`, `Panel`, `Tree`, `Syntax` 등 rich의 렌더러블을 Textual 위젯 내부에서 `Static.update(renderable)` 패턴으로 활용.
- 기존 `InteractionUI` 클래스(`interaction_ui.py`)의 rich 기반 렌더링 로직을 위젯으로 래핑하여 재사용.


---

## 6. 장단점 비교

### 6.1 장점

| 장점 | 설명 |
|------|------|
| **기존 코드 재활용** | `bi_agent_console.py`의 위젯, Screen, 핸들러를 대부분 재사용. 새로 작성할 코드가 적음. |
| **풍부한 UI** | DataTable, 차트 프리뷰, 모달 Screen 등 Textual이 제공하는 풀스크린 TUI의 장점을 그대로 활용. |
| **레이아웃 유연성** | TCSS 변경만으로 레이아웃을 쉽게 조정 가능. 사이드바 토글, 패널 크기 조절 등. |
| **테스트 용이성** | Textual `pilot`으로 UI 테스트 자동화 가능. |
| **Screen 오버레이** | 연결 설정, 스키마 탐색 등 복잡한 플로우를 모달 Screen으로 깔끔하게 처리. |

### 6.2 단점

| 단점 | 설명 |
|------|------|
| **CLI 느낌 제한** | Textual은 본질적으로 TUI 프레임워크. 아무리 CLI처럼 꾸며도 진짜 터미널 스크롤 느낌과는 차이가 있음. |
| **Input 위젯 한계** | Textual의 `Input`은 prompt_toolkit 대비 자동완성, 멀티라인 입력, vi/emacs 키맵 등에서 기능이 부족함. 커스터마이징 필요. |
| **학습 곡선** | Textual 위젯 시스템, TCSS, 메시지 패싱에 대한 이해가 필요. |
| **터미널 호환성** | Textual은 일부 터미널(특히 Windows cmd)에서 렌더링 이슈가 있을 수 있음. |
| **풀스크린 점유** | 터미널 전체를 점유하므로 다른 터미널 작업과 동시에 사용하기 어려움. (tmux/screen 필요) |


---

## 7. 파일 구조 변경 예상

```
backend/orchestrator/
  bi_agent_console.py        # compose() 재작성, 레이아웃 변경
  ui/
    app_styles_split.tcss    # 신규 TCSS (Split Pane 레이아웃)
    components/
      result_block.py        # 신규: 질문-응답 카드 위젯
      banner_widget.py       # 신규: ASCII 배너 위젯
      cli_input.py           # 신규: 히스토리/자동완성 강화 Input
      interaction_ui.py      # 기존 유지 (rich 렌더링 유틸)
      hud_statusline.py      # 기존 유지 (위치만 변경)
      thinking_translator.py # 기존 유지
    views/
      analysis_view.py       # 기존 유지
      dashboard_view.py      # 기존 유지
  components/
    sidebar_manager.py       # 수정: 토글 오버레이로 전환
    command_palette.py       # 수정: 드롭업 위치 변경
```


---

## 8. 마이그레이션 전략

### 8.1 점진적 전환

1. **새 TCSS 파일 작성** -> 기존 TCSS와 병행 (CSS_PATH 스위칭)
2. **compose() 분기** -> 환경변수 `BI_AGENT_UI=split` 으로 레이아웃 선택 가능
3. **기존 엔트리포인트 유지** -> `bi-agent` (기존 TUI), `bi-agent-cli` (기존 REPL) 모두 유지
4. **새 엔트리포인트 추가** -> `bi-agent-v2` 또는 `bi-agent --ui split`

### 8.2 롤백 계획

- 기존 `app_styles.tcss`와 현재 `compose()` 코드를 브랜치로 보존
- 문제 발생 시 `CSS_PATH` 변경만으로 즉시 롤백 가능


---

## 9. 리스크 및 완화 방안

| 리스크 | 확률 | 영향 | 완화 방안 |
|--------|------|------|-----------|
| Textual Input 위젯의 자동완성 구현 난이도 | 중 | 중 | Textual의 `Suggester` 클래스 활용, 부족하면 커스텀 위젯 개발 |
| 히스토리 패널 성능 저하 (대량 블록) | 낮 | 중 | 가상 스크롤 또는 오래된 블록 DOM에서 제거 |
| 기존 Screen/Modal과의 충돌 | 낮 | 높 | Screen은 오버레이이므로 레이아웃과 독립적. 테스트로 확인 |
| TCSS 복잡도 증가 | 중 | 낮 | 변수/테마 시스템 도입, TCSS 모듈화 |


---

## 10. 예상 일정

| Phase | 작업 | 예상 소요 |
|-------|------|-----------|
| Phase 1 | 레이아웃 재구성 | 2-3일 |
| Phase 2 | CLI 입력 강화 | 2일 |
| Phase 3 | 결과 렌더링 고도화 | 2-3일 |
| Phase 4 | 배너 및 상태 통합 | 1일 |
| Phase 5 | 통합 테스트 및 폴리싱 | 2일 |
| **합계** | | **9-11일** |


---

## 부록: 핵심 위젯 재사용 매핑

| 기존 위젯 | Plan A에서의 역할 | 변경 수준 |
|-----------|-------------------|-----------|
| `MessageBubble` | 히스토리 패널 내 질문/응답 표시 | 스타일만 수정 |
| `ThinkingPanel` | 히스토리 하단 인라인 표시 | 위치 변경 |
| `StreamingMessageView` | 스트리밍 응답 표시 | 그대로 사용 |
| `ToolActivityTracker` | ThinkingPanel 내부 단계 표시 | 그대로 사용 |
| `HUDStatusLine` | 히스토리-입력 사이 1줄 바 | 위치 변경 |
| `CommandPalette` | 입력 위 드롭업 | 위치/트리거 변경 |
| `DataTable` | 결과 블록 내 데이터 표시 | 그대로 사용 |
| `ErrorViewerScreen` | Ctrl+E 오버레이 | 그대로 사용 |
